<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <meta name='viewport' content='width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;' />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    

    <title>Foosball</title>
    
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.0b3/jquery.mobile-1.0b3.min.css" />
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.3.min.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/mobile/1.0b3/jquery.mobile-1.0b3.min.js"></script>
    
    <style type="text/css">
        .ui-header .ui-title, 
        .ui-footer .ui-title
        {
            margin: 0.6em 0px 0.8em 0px;
        }
        
        
        .hidden 
        {
            display:none;
        }
        
        .scores 
        {
            font-size:2em;
            text-align:center;
        }
        .winningScore
        {
            color:Green;
            font-weight:bold;
        }
        .losingScore
        {
        }
        
        .caption
        {
            font-size:0.8em;
        }
        
        .scoreButton
        {
            height:100px;
            vertical-align:middle;
        }
    </style>
</head>
<body>


<div id="pageSystemSettings" data-role="page"> 
    <div data-role="header" data-position="inline">
        <h1>System Settings</h1>
    </div>
    
    <div data-role="content">
        <a href="#" data-role="button" data-icon="grid" onclick="Foosball.DOMHelper.gotoPagePlayerList();">Players</a>
        <a href="#" data-role="button" data-icon="plus" onclick="Foosball.DOMHelper.addPlayer(); return false;">Player</a>
    </div>
    
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="grid" onclick="Foosball.DOMHelper.gotoPageGameList();">Games</a>
        <a href="#" data-role="button" data-icon="plus" onclick="Foosball.DOMHelper.addGame(); return false;">Game</a>
        <a href="#" data-role="button" data-icon="gear" onclick="Foosball.DOMHelper.gotoPageSystemSettings();" class="ui-btn-active ui-state-persist">System</a>
    </div>
</div>



<div id="pageGameList" data-role="page"> 
    <div data-role="header" data-position="inline">
        <h1>Game List</h1>
    </div>
    
    <div data-role="content">
        <ul id="gameList" data-role="listview" data-theme="c"></ul>
    </div>
    
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="grid" onclick="Foosball.DOMHelper.gotoPageGameList();" class="ui-btn-active ui-state-persist">Games</a>
        <a href="#" data-role="button" data-icon="plus" onclick="Foosball.DOMHelper.addGame(); return false;">Game</a>
        <a href="#" data-role="button" data-icon="gear" onclick="Foosball.DOMHelper.gotoPageSystemSettings();">System</a>
    </div>
</div>

<div id="pageGameDetails" data-role="page">
    <div data-role="header">
        <h1 id="pageGameDetails_Title"></h1>
    </div>
    <div data-role="content">
        <input type="hidden" name="pageGameDetails_Id" id="pageGameDetails_Id" />
        <div id="pageGameDetails_Scores" class="scores"></div>

        <fieldset class="ui-grid-a">
            <div class="ui-block-a">
                <a href="#" data-role="button" data-theme="a" class="scoreButton" 
                    onclick="Foosball.DOMHelper.addPoint('t1p1');">
                    <input type="hidden" id="pageGameDetails_t1p1Id" />
                    <span id="pageGameDetails_t1p1Name"></span><br />
                    (<span id="pageGameDetails_t1p1Points"></span>)<br />
                    <span class="caption">Offense</span>
                </a>
            </div>
            <div class="ui-block-b">
                <a href="#" data-role="button" data-theme="a" class="scoreButton" 
                    onclick="Foosball.DOMHelper.addPoint('t1p2');">
                    <input type="hidden" id="pageGameDetails_t1p2Id" />
                    <span id="pageGameDetails_t1p2Name"></span><br />
                    (<span id="pageGameDetails_t1p2Points"></span>)<br />
                    <span class="caption">Defense</span>
                </a>
            </div>	   
        </fieldset>
        
        
        <fieldset class="ui-grid-a">
            <div class="ui-block-a">
                <a href="#" data-role="button" data-theme="c" class="scoreButton" 
                    onclick="Foosball.DOMHelper.addPoint('t2p2');">
                    <input type="hidden" id="pageGameDetails_t2p2Id" />
                    <span id="pageGameDetails_t2p2Name"></span><br />
                    (<span id="pageGameDetails_t2p2Points"></span>)<br />
                    <span class="caption">Defense</span>
                </a>
            </div>
            <div class="ui-block-b">
                <a href="#" data-role="button" data-theme="c" class="scoreButton" 
                    onclick="Foosball.DOMHelper.addPoint('t2p1');">
                    <input type="hidden" id="pageGameDetails_t2p1Id" />
                    <span id="pageGameDetails_t2p1Name"></span><br />
                    (<span id="pageGameDetails_t2p1Points"></span>)<br />
                    <span class="caption">Offense</span>
                </a>
            </div>	   
        </fieldset>
            
            

    </div>
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="arrow-l" onclick="Foosball.DOMHelper.gotoPageGameList(true);">Back</a>
        <a href="#" data-role="button" onclick="Foosball.DOMHelper.gotoPageGameSettings($('#pageGameDetails_Id').val());">Settings</a>
    </div>
</div>

<div id="pageGameSettings" data-role="page">
    <div data-role="header" data-position="inline">
        <h1 id="pageGameSettings_Title"></h1>
    </div>
    <div data-role="content">
        <input type="hidden" name="pageGameSettings_Id" id="pageGameSettings_Id" />
        <!--
        <div data-role="fieldcontain">
            <label for="pageGameSettings_Name">Game Name</label>
            <input type="text" name="pageGameSettings_Name" id="pageGameSettings_Name" />
        </div>
        -->
        <div data-role="fieldcontain">
            <label>Black</label><br />
            <select name="pageGameSettings_t1p1" id="pageGameSettings_t1p1"></select>
            <select name="pageGameSettings_t1p2" id="pageGameSettings_t1p2"></select>
        </div>	
        <div data-role="fieldcontain">
            <label>White</label><br />
            <select name="pageGameSettings_t2p1" id="pageGameSettings_t2p1"></select>
            <select name="pageGameSettings_t2p2" id="pageGameSettings_t2p2"></select>
        </div>
        <fieldset class="ui-grid-a">
            <div class="ui-block-a"><input type="button" value="Cancel" onclick="Foosball.DOMHelper.gotoPageGameDetails($('#pageGameSettings_Id').val(), true);" /></div>
            <div class="ui-block-b"><input type="button" data-theme="b" value="Update" onclick="Foosball.DOMHelper.updateGame($('#pageGameSettings_Id').val());" /></div>	   
        </fieldset>
    </div>
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="arrow-l" onclick="Foosball.DOMHelper.gotoPageGameDetails($('#pageGameSettings_Id').val(), true);">Back</a>
    </div>
</div>



<div id="pagePlayerList" data-role="page"> 
    <div data-role="header" data-position="inline">
        <h1>Player List</h1>
    </div>
    
    <div data-role="content">
        <ul id="playerList" data-role="listview" data-filter="true" data-theme="c"></ul>
    </div>
    
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="arrow-l" onclick="Foosball.DOMHelper.gotoPageSystemSettings(true);">Back</a>
    </div>
</div>

<div id="pagePlayerSettings" data-role="page">
    <div data-role="header" data-position="inline">
        <h1 id="pagePlayerSettings_Title"></h1>
    </div>
    <div data-role="content">
        <input type="hidden" name="pagePlayerSettings_Id" id="pagePlayerSettings_Id" />
        <div data-role="fieldcontain">
            <label for="pagePlayerSettings_Name">Player Name</label>
            <input type="text" name="pagePlayerSettings_Name" id="pagePlayerSettings_Name" />
        </div>	
        <fieldset class="ui-grid-a">
            <div class="ui-block-a"><input type="button" value="Cancel" onclick="Foosball.DOMHelper.gotoPagePlayerList(true);" /></div>
            <div class="ui-block-b"><input type="button" data-theme="b" value="Update" onclick="Foosball.DOMHelper.updatePlayer($('#pagePlayerSettings_Id').val());" /></div>	   
        </fieldset>
    </div>
    <div data-role="footer" data-id="myFooter" data-position="fixed" class="ui-bar">
        <a href="#" data-role="button" data-icon="arrow-l" onclick="Foosball.DOMHelper.gotoPagePlayerList(true);">Back</a>
    </div>
</div>



</body>
<script language="javascript" type="text/javascript">
// __TODO__ 
// - Right now we're saving the whole Foosball.System as one object in localStorage.
//   We can improve this by breaking the object up and saving individual objects separately.
// - Look into saving data to Dropbox
// - We don't have "foreign key" check.  Could use it, but low priority right now.


var Foosball = Foosball || {};

Foosball.DOMHelper = function () { }
Foosball.DOMHelper.initialize = function (name) {
    // need to refresh both lists after resume
    // but we're automatically refreshing the game list by calling gotoPageGameList()
    Foosball.DOMHelper.refreshPlayerList();
    Foosball.DOMHelper.gotoPageGameList();
}

Foosball.DOMHelper.gotoPageSystemSettings = function (transitionReverse) {
    $.mobile.changePage("#pageSystemSettings", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}
Foosball.DOMHelper.gotoPageGameList = function (transitionReverse) {
    Foosball.DOMHelper.refreshGameList();
    $.mobile.changePage("#pageGameList", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}
Foosball.DOMHelper.gotoPageGameSettings = function (gameId, transitionReverse) {
    $("#pageGameSettings_Title").html("Game #" + system.Games[gameId].Id);

    $("#pageGameSettings_Id").val(system.Games[gameId].Id);
    $("#pageGameSettings_Name").val(system.Games[gameId].Name);


    var t1p1 = t1p2 = t2p1 = t2p2 = -1;

    // we check this to make sure the PlayerId is valid (aka exists in the Players list)
    try { t1p1 = system.Players[system.Games[gameId].Team1.Player1Id].Id; } catch (error) { }
    try { t1p2 = system.Players[system.Games[gameId].Team1.Player2Id].Id; } catch (error) { }
    try { t2p1 = system.Players[system.Games[gameId].Team2.Player1Id].Id; } catch (error) { }
    try { t2p2 = system.Players[system.Games[gameId].Team2.Player2Id].Id; } catch (error) { }

    $("#pageGameSettings_t1p1").val(t1p1);
    $("#pageGameSettings_t1p2").val(t1p2);
    $("#pageGameSettings_t2p1").val(t2p1);
    $("#pageGameSettings_t2p2").val(t2p2);

    try { $("#pageGameSettings_t1p1").selectmenu('refresh'); } catch (error) { }
    try { $("#pageGameSettings_t1p2").selectmenu('refresh'); } catch (error) { }
    try { $("#pageGameSettings_t2p1").selectmenu('refresh'); } catch (error) { }
    try { $("#pageGameSettings_t2p2").selectmenu('refresh'); } catch (error) { }

    $.mobile.changePage("#pageGameSettings", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}
Foosball.DOMHelper.gotoPageGameDetails = function (gameId, transitionReverse) {
    $("#pageGameDetails_Title").html(system.getGameName(gameId));

    $("#pageGameDetails_Id").val(system.Games[gameId].Id);
    $("#pageGameDetails_Name").val(system.Games[gameId].Name);
    $("#pageGameDetails_Scores").html(system.getScoresHtml(gameId));


    var t1p1Id = t1p2Id = t2p1Id = t2p2Id = -1;
    var t1p1Name = t1p2Name = t2p1Name = t2p2Name = "??";
    try { t1p1Id = system.Players[system.Games[gameId].Team1.Player1Id].Id; t1p1Name = system.Players[system.Games[gameId].Team1.Player1Id].Name; } catch (error) { }
    try { t1p2Id = system.Players[system.Games[gameId].Team1.Player2Id].Id; t1p2Name = system.Players[system.Games[gameId].Team1.Player2Id].Name; } catch (error) { }
    try { t2p1Id = system.Players[system.Games[gameId].Team2.Player1Id].Id; t2p1Name = system.Players[system.Games[gameId].Team2.Player1Id].Name; } catch (error) { }
    try { t2p2Id = system.Players[system.Games[gameId].Team2.Player2Id].Id; t2p2Name = system.Players[system.Games[gameId].Team2.Player2Id].Name; } catch (error) { }

    $("#pageGameDetails_t1p1Id").val(t1p1Id);
    $("#pageGameDetails_t1p2Id").val(t1p2Id);
    $("#pageGameDetails_t2p1Id").val(t2p1Id);
    $("#pageGameDetails_t2p2Id").val(t2p2Id);

    $("#pageGameDetails_t1p1Name").html(t1p1Name);
    $("#pageGameDetails_t1p2Name").html(t1p2Name);
    $("#pageGameDetails_t2p1Name").html(t2p1Name);
    $("#pageGameDetails_t2p2Name").html(t2p2Name);

    $("#pageGameDetails_t1p1Points").html(system.getPointsByPlayer(gameId, system.Games[gameId].Team1.Player1Id));
    $("#pageGameDetails_t1p2Points").html(system.getPointsByPlayer(gameId, system.Games[gameId].Team1.Player2Id));
    $("#pageGameDetails_t2p1Points").html(system.getPointsByPlayer(gameId, system.Games[gameId].Team2.Player1Id));
    $("#pageGameDetails_t2p2Points").html(system.getPointsByPlayer(gameId, system.Games[gameId].Team2.Player2Id));


    $.mobile.changePage("#pageGameDetails", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}
Foosball.DOMHelper.gotoPagePlayerList = function (transitionReverse) {
    Foosball.DOMHelper.refreshPlayerList();
    $.mobile.changePage("#pagePlayerList", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}
Foosball.DOMHelper.gotoPagePlayerSettings = function (playerId, transitionReverse) {
    $("#pagePlayerSettings_Title").html("Player #" + system.Players[playerId].Id);

    $("#pagePlayerSettings_Id").val(system.Players[playerId].Id);
    $("#pagePlayerSettings_Name").val(system.Players[playerId].Name);

    $.mobile.changePage("#pagePlayerSettings", {
        transition: "slide",
        reverse: transitionReverse || false
    });
}

Foosball.DOMHelper.refreshGameList = function () {
    $("#gameList").html('');
    for (var ii in system.Games) {
        var scores = system.getScores(system.Games[ii].Id);
        $("#gameList").append(
            "<li><a href='#pageGameDetails'" +
                " onclick='Foosball.DOMHelper.gotoPageGameDetails(" + system.Games[ii].Id + "); return false;'>" +
                scores[0] + "-" + scores[1] + " " + system.getGameName(ii) +
            "</a></li>"
        );
    }
    try { $("#gameList").listview('refresh'); } catch (error) { }
}
Foosball.DOMHelper.refreshPlayerList = function () {
    $("#playerList").html('');
    for (var ii in system.Players) {
        $("#playerList").append(
            "<li><a href='#pagePlayerSettings'" +
            " onclick='Foosball.DOMHelper.gotoPagePlayerSettings(" + system.Players[ii].Id + "); return false;'>" +
            system.Players[ii].Id + ": " + system.Players[ii].Name + "</a></li>"
        );
    }
    try { $("#playerList").listview('refresh'); } catch (error) { }


    // also refresh the player list in the GameSettings page
    var playerOptions = "<option value='-1'>Select Player</option>";
    for (var ii in system.Players) {
        playerOptions += "<option value='" + system.Players[ii].Id + "'>" + system.Players[ii].Name + "</option>";
    }
    $("#pageGameSettings_t1p1").html(playerOptions);
    $("#pageGameSettings_t1p2").html(playerOptions);
    $("#pageGameSettings_t2p1").html(playerOptions);
    $("#pageGameSettings_t2p2").html(playerOptions);
}

Foosball.DOMHelper.addGame = function () {
    var newId = system.addGame();
    Foosball.DOMHelper.gotoPageGameSettings(newId);
}
Foosball.DOMHelper.addPlayer = function () {
    var newId = system.addPlayer();
    Foosball.DOMHelper.gotoPagePlayerSettings(newId);
}
Foosball.DOMHelper.updateGame = function (gameId) {
    system.updateGame(gameId,
        $('#pageGameSettings_Name').val(),
        $('#pageGameSettings_t1p1').val(),
        $('#pageGameSettings_t1p2').val(),
        $('#pageGameSettings_t2p1').val(),
        $('#pageGameSettings_t2p2').val()
    );
    Foosball.DOMHelper.gotoPageGameDetails(gameId, true);
}
Foosball.DOMHelper.updatePlayer = function (playerId) {
    system.updatePlayer(playerId, $('#pagePlayerSettings_Name').val());
    Foosball.DOMHelper.gotoPagePlayerList(true);
}
Foosball.DOMHelper.addPoint = function (position) {
    system.addPoint($('#pageGameDetails_Id').val(), $('#pageGameDetails_' + position + 'Id').val());

    $('#pageGameDetails_' + position + 'Points').html(parseInt($('#pageGameDetails_' + position + 'Points').html()) + 1);
    $('#pageGameDetails_Scores').html(Foosball.DOMHelper.getScoresHtml($('#pageGameDetails_Id').val()));
}


Foosball.System = function () {
    this.__namespace = "Foosball";
    this.__name = "System";
    this.Players = new Array();
    this.Games = new Array();
}
Foosball.System.prototype.resumeState = function () {
    // we can only save data as JSON (e.g. can't save functions)
    // so when we restore it, we have to set the data to an instance of Foosball.System
    // in this case: self
    var data = JSON.parse(localStorage.getItem(this.__namespace + "-" + this.__name));
    this.Players = data != null ? data.Players : new Array();
    this.Games = data != null ? data.Games : new Array();

}
Foosball.System.prototype.saveState = function () {
    localStorage.setItem(this.__namespace + "-" + this.__name, JSON.stringify(this));
}
Foosball.System.prototype.addGame = function () {
    // add a game to the history
    var newId = this.Games.length;
    var newItem = new Foosball.Game();
    newItem.Id = newId;
    newItem.Name = "";
    newItem.Team1 = new Foosball.Team();
    newItem.Team2 = new Foosball.Team();
    newItem.StartDate = new Date();

    this.Games[newId] = newItem;
    this.saveState();

    return newId;
}
Foosball.System.prototype.addPlayer = function () {
    var newId = this.Players.length;
    var newItem = new Foosball.Player();
    newItem.Id = newId;
    newItem.Name = "";

    this.Players[newId] = newItem;
    this.saveState();

    return newId;
}
Foosball.System.prototype.addPoint = function (gameId, playerId) {
    var newPoint = new Foosball.Point();
    newPoint.PlayerId = playerId;
    newPoint.Timestamp = new Date();

    this.Games[gameId].Points.push(newPoint);
    this.saveState();
}
Foosball.System.prototype.updateGame = function (gameId, name, t1p1, t1p2, t2p1, t2p2) {
    this.Games[gameId].Name = name;
    this.Games[gameId].Team1.Player1Id = t1p1;
    this.Games[gameId].Team1.Player2Id = t1p2;
    this.Games[gameId].Team2.Player1Id = t2p1;
    this.Games[gameId].Team2.Player2Id = t2p2;

    this.saveState();
}
Foosball.System.prototype.updatePlayer = function (playerId, name) {
    this.Players[playerId].Name = name;

    this.saveState();
}


Foosball.System.prototype.getGameName = function (gameId) {
    var result = this.Games[gameId].Name;
    if ((result + "") == "") {
        var t1p1 = t1p2 = t2p1 = t2p2 = "??";
        try { t1p1 = this.Players[this.Games[gameId].Team1.Player1Id].Name; } catch (error) { }
        try { t1p2 = this.Players[this.Games[gameId].Team1.Player2Id].Name; } catch (error) { }
        try { t2p1 = this.Players[this.Games[gameId].Team2.Player1Id].Name; } catch (error) { }
        try { t2p2 = this.Players[this.Games[gameId].Team2.Player2Id].Name; } catch (error) { }

        var t1 = (t1p1 == t1p2 ? t1p1 : t1p1 + " / " + t1p2);
        var t2 = (t2p1 == t2p2 ? t2p1 : t2p1 + " / " + t2p2);

        result = t1 + " vs " + t2;
    }
    return result;
}
Foosball.System.prototype.getScores = function (gameId) {
    var result = new Array();

    var team1Points = team2Points = 0;
    for (var ii in this.Games[gameId].Points) {
        if (this.Games[gameId].Points[ii].PlayerId == this.Games[gameId].Team1.Player1Id ||
            this.Games[gameId].Points[ii].PlayerId == this.Games[gameId].Team1.Player2Id) {
            team1Points++;
        }

        if (this.Games[gameId].Points[ii].PlayerId == this.Games[gameId].Team2.Player1Id ||
            this.Games[gameId].Points[ii].PlayerId == this.Games[gameId].Team2.Player2Id) {
            team2Points++;
        }
    }

    result[0] = team1Points;
    result[1] = team2Points;
    return result;
}
Foosball.System.prototype.getScoresHtml = function (gameId) {
    var result = "";
    var scores = this.getScores(gameId);
    if (scores[0] > scores[1]) {
        result = "<span class='winningScore'>" + scores[0] + "</span> - <span class='losingScore'>" + scores[1] + "</span>";
    } else if (scores[0] < scores[1]) {
        result = "<span class='losingScore'>" + scores[0] + "</span> - <span class='winningScore'>" + scores[1] + "</span>";
    } else {
        result = "<span>" + scores[0] + "</span> - <span>" + scores[1] + "</span>";
    }
    return result;
}
Foosball.System.prototype.getPointsByPlayer = function (gameId, playerId) {
    var result = 0;

    for (var ii in this.Games[gameId].Points) {
        if (this.Games[gameId].Points[ii].PlayerId == playerId) {
            result++;
        }
    }

    return result;
}

Foosball.Player = function () {
    this.Id = 0;
    this.Name = "";
}
Foosball.Game = function () {
    this.Id = 0;
    this.Name = "";
    this.Team1 = null; // black
    this.Team2 = null; // white
    this.Points = new Array();
    this.StartDate = null;
    this.EndDate = null;
}
Foosball.Team = function () {
    this.Player1Id = null; // offense
    this.Player2Id = null; // defense
}
Foosball.Point = function () {
    this.PlayerId = null;
    this.Timestamp = null;
}









// jquery mobile settings 
$(document).bind("mobileinit", function(){
    $.mobile.defaultPageTransition = "fade";
});


// start up code
var system;
$(document).ready(function () {
    system = new Foosball.System();
    system.resumeState();

    Foosball.DOMHelper.initialize();
});
</script>
</html>